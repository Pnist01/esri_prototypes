<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
    <title>Parcel Locator</title>
    <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/2.8/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/2.8/js/esri/dijit/css/Popup.css">
    <style>
      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      .esriScalebar {
        padding: 20px 20px;
      }
      #map {
        padding:0;
      }
    </style>
    <script type="text/javascript">
      var djConfig = {
        parseOnLoad: true
      };
    </script>
    <script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=2.8"></script>
    <script type="text/javascript">
      dojo.require("dijit.layout.BorderContainer");
      dojo.require("dijit.layout.ContentPane");
      dojo.require("esri.map");
      dojo.require("esri.layers.FeatureLayer");
      dojo.require("esri.dijit.Popup");
      dojo.require("esri.tasks.closestfacility");
      
      var map;
      var parking;
		esri.config.defaults.io.proxyUrl = "/proxy";

      function init() {
        //apply a selection symbol that determines the symbology for selected features 
        var sfs = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([111, 0, 255]), 2), new dojo.Color([111, 0, 255, 0.15]));

        var popup = new esri.dijit.Popup({
          fillSymbol: sfs
        }, dojo.create("div"));

        map = new esri.Map("map", {
          infoWindow: popup
        });
		var basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer");
	    map.addLayer(basemap);
	    map.setExtent( new esri.geometry.Extent({
	    	xmax: -17529456,
	    	xmin: -17637844,
	    	ymax: 2472699,
	    	ymin: 2420493
	    }) );

        //apply a popup template to the parking layer to format popup info 
        var popupTemplate = new esri.dijit.PopupTemplate({
          title: "{Loc_name}",
          fieldInfos: [{
            fieldName: "Address",
            label: 'Address:',
            visible: true
          }, {
            fieldName: "Entry",
            label: "Entry:",
            visible: true
          }, {
            fieldName: "Exit",
            label: "Exit:",
            visible: true
          }]
        });



        //add the parking layer to the map as a feature layer in selection mode
        parking = new esri.layers.FeatureLayer("http://services.arcgis.com/tNJpAOha4mODLkXz/arcgis/rest/services/PARKING_HNL/FeatureServer/0", {
          outFields: ["*"]
        });

        parking.setSelectionSymbol(sfs);


			var incidentPointSymbol = new esri.symbol.SimpleMarkerSymbol(
				esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE, 
				16,
				new esri.symbol.SimpleLineSymbol(
					esri.symbol.SimpleLineSymbol.STYLE_SOLID,
					new dojo.Color([89,95,35]), 2
				),
				new dojo.Color([0,200,0,0.4]) );
			incidentsGraphicsLayer = new esri.layers.GraphicsLayer();

			var incidentsRenderer = new esri.renderer.SimpleRenderer(incidentPointSymbol);
			incidentsGraphicsLayer.setRenderer(incidentsRenderer);
			map.addLayer(incidentsGraphicsLayer);

        //when users click on the map select the parcel using the map point and update the url parameter
        dojo.connect(map, 'onClick', function (e) {
          var query = new esri.tasks.Query();
          query.geometry = map.extent;
          var deferred = parking.queryFeatures(query, function(featureset){
          	closestFacilityTask = new esri.tasks.ClosestFacilityTask("http://maps.esri.com/apl4/rest/services/CCH/StreetNetwork/NAServer/Closest Facility");
    		params = new esri.tasks.ClosestFacilityParameters();
    		params.defaultCutoff= 3.0;
    		params.returnIncidents=false;
    		params.returnRoutes=true;
		    params.returnDirections=false;
		    params.incidents = new esri.tasks.FeatureSet();
		    params.incidents.features = [ featureset.features[0] ];

		    params.facilities = new esri.tasks.FeatureSet();

		    params.facilities.features = featureset.features;


		    closestFacilityTask.solve(params,function(solveResult){
		    	console.log(solveResult);
        //var directions = solveResult.directions;
        
        dojo.forEach(solveResult.routes, function(route, index){
          //build an array of route info
          var attr = dojo.map(solveResult.directions[index].features,function(feature){
            return feature.attributes.text;
          });
          var infoTemplate = new esri.InfoTemplate("Attributes", "${*}");
          
          route.setInfoTemplate(infoTemplate);
          route.setAttributes(attr);
          
          routeGraphicLayer.add(route);
          dojo.byId("directionsDiv").innerHTML = "Hover over the route to view directions";
        });
        
		    });
          });
          //console.log(deferred.results[0][0]);
          var minDistance = 1000000000000;
          var minPark = null;
          dojo.forEach(deferred.results[0].features, function(space){
          	var distance = Math.pow(e.mapPoint.x - space.geometry.x, 2) + Math.pow(e.mapPoint.y - space.geometry.y, 2)
          	if(distance < minDistance){
          		minDistance = distance;
          		minPark = space;
          	}
          });
          //console.log(minPark);
			incidentsGraphicsLayer.clear();
			incidentsGraphicsLayer.add(new esri.Graphic( new esri.geometry.Point( minPark.geometry.x,  minPark.geometry.y )));

        });

        map.addLayers([parking]);

        dojo.connect(map, 'onLoad', function (theMap) {
          //resize the map when the browser resizes
          dojo.connect(dijit.byId('map'), 'resize', map, map.resize);
        });
      }

      dojo.addOnLoad(init);
    </script>
  </head>
  <body class="claro">
    <div dojotype="dijit.layout.BorderContainer" design="headline" gutters="false"
    style="width: 100%; height: 100%; margin: 0;">
      <div id="map" dojotype="dijit.layout.ContentPane" region="center" style="border:1px solid #000;padding:0;"></div>
    </div>
  </body>
</html>
